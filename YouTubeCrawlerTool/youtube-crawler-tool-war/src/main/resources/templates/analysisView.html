<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <thymeleaf th:replace="sections/header :: header" />
</head>
<body>
	<div id="wrapper">
		<thymeleaf th:replace="sections/leftMenu :: leftMenu" />
        <div id="page-wrapper">
        
        	<div class="row">
        		<div class="col-lg-12">
        			<h1 class="page-header">Analysis</h1>
        		</div>
        	</div>
        
        	<div class="row">
        		<div class="col-lg-12">
                	<div class="panel panel-default">
                        <div class="panel-heading">Search</div>
                        <div class="panel-body">
	                        <form role="form" id="searchForm">
	                            <fieldset>
	                            	<div class="row">
		                            	<div class="form-group col-md-5">
			                            	<label>From:</label> 
									        <div class="input-group input-append date datePicker">
									        	<input type="text" class="form-control" name="fromDate" />
									            <span class="input-group-addon add-on"><span class="fa fa-calendar"></span></span>
									        </div>
							                <p class="help-block">Default value: 14/02/2005</p>
	                                    </div>
	                                    <div class="form-group col-md-5">
	                                    	<label>To:</label>
	                                    	<div class="input-group input-append date datePicker">
									        	<input type="text" class="form-control" name="toDate" />
									            <span class="input-group-addon add-on"><span class="fa fa-calendar"></span></span>
									        </div>
	                                       	<p class="help-block">Default value: today</p>
	                                    </div>
	                                    <div class="form-group col-md-2">
	                                    	<label>Include channels:</label>
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" name="includeChannels" value="">
                                                </label>
                                            </div>
	                                    </div>
                                    </div>
                                    <div class="row">
		                                <div class="form-group col-md-12">
		                                	<button type="button" class="btn btn-danger" id="search">Search</button>
		                                </div>
	                                </div>
	                            </fieldset>
	                        </form> 
                        </div>
                    </div>
                </div>
        	</div>
        	
        	<div class="row">
        		<div class="col-lg-12">
        			<div class="panel panel-default panel-graph">
                        <div class="panel-body">
                        	<div id="cy"></div>
                        </div>
                    </div>
        		</div>
        	</div>
        	
        </div>	    
	</div>	
	
	<script>
		// The graph variable
		var cy;
		
		// Perform analysis search and create a new graph
	    $('#search').on('click', function() {
	    	var searchFields = getFormFields("searchForm");
	    	doPost("/api/graphs", searchFields, function (data) {  
		    	if (data.elements.nodes == null) {
	    			$('#cy').html("<div class='alert alert-warning text-center'>No results found</div>");
	    		} else {
	    			$('#cy').html("");
	    			initCytoscape(data.elements);
	    		}
	    	});
	    })

		//Create a graph
		function initCytoscape(elements) {
			cy = cytoscape({
			  container: document.querySelector('#cy'),
			  boxSelectionEnabled: false,
			  autounselectify: true,
			  style: cytoscape.stylesheet()
			    .selector('node')
			      .css({
			        'content': 'data(resourceId)',
			        'text-valign': 'center',
			        'color': 'white',
			        'text-outline-width': 2,
			        'text-outline-color': '#999',
			       	'shape': 'data(shape)',
			        'background-color': 'data(color)',
			        'width': 'data(size)',
			        'height': 'data(size)'
			      })
			    .selector('edge')
			      .css({
			        'curve-style': 'bezier',
			        'target-arrow-shape': 'triangle',
			        'target-arrow-color': '#ccc',
			        'line-color': '#ccc',
			        'width': 1
			      })
			    .selector(':selected')
			      .css({
			        'background-color': 'black',
			        'line-color': 'black',
			        'target-arrow-color': 'black',
			        'source-arrow-color': 'black'
			      })
			    .selector('.faded')
			      .css({
			        'opacity': 0.25,
			        'text-opacity': 0
			      }),
			  elements: elements,
			  layout: {
			        name: 'cose',
			        idealEdgeLength: 100,
			        nodeOverlap: 20,
			        refresh: 20,
			        fit: true,
			        padding: 30,
			        randomize: false,
			        componentSpacing: 100,
			        nodeRepulsion: 400000,
			        edgeElasticity: 100,
			        nestingFactor: 5,
			        gravity: 80,
			        numIter: 1000,
			        initialTemp: 200,
			        coolingFactor: 0.95,
			        minTemp: 1.0
			      }
			});
			
			cy.nodes().forEach(function(node){
			  nodeJson = node.json();
			  cy.$('#'+node.id()).qtip({
				  content: nodeJson.data.name,
				  position: {
				    my: 'top center',
				    at: 'bottom center'
				  },
				  style: {
				    classes: 'qtip-bootstrap',
				    tip: {
				      width: 16,
				      height: 8
				    }
				  }
				});
			});
			
			cy.on('tap', function(e){
			  if( e.cyTarget === cy ){
			    cy.elements().removeClass('faded');
			  }
			});
			
			// Graph opntions
			$('#cy').append("<div id='cyOptions'></div>");
			//Enable fullscrean option
			$('#cyOptions').append("<button type='button' class='btn btn-default' id='toggle_fullscreen' data-toggle='tooltip' data-placement='bottom' title='' data-original-title='Toggle fullscreen'><i class='fa fa-lg fa-arrows-alt'></i></button>");
			$('#toggle_fullscreen').on('click', function(){
	    	  if (document.fullscreenElement ||
	    	    document.webkitFullscreenElement ||
	    	    document.mozFullScreenElement ||
	    	    document.msFullscreenElement) {
	    	    if (document.exitFullscreen) {
	    	      document.exitFullscreen();
	    	    } else if (document.mozCancelFullScreen) {
	    	      document.mozCancelFullScreen();
	    	    } else if (document.webkitExitFullscreen) {
	    	      document.webkitExitFullscreen();
	    	    } else if (document.msExitFullscreen) {
	    	      document.msExitFullscreen();
	    	    }
	    	  } else {
	    	    element = $('#cy').get(0);
	    	    if (element.requestFullscreen) {
	    	      element.requestFullscreen();
	    	    } else if (element.mozRequestFullScreen) {
	    	      element.mozRequestFullScreen();
	    	    } else if (element.webkitRequestFullscreen) {
	    	      element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
	    	    } else if (element.msRequestFullscreen) {
	    	      element.msRequestFullscreen();
	    	    }
	    	  }
	    	});
			// Enable save graph as image option
			$('#cyOptions').append("<button type='button' class='btn btn-default' style='left:53px' id='take_picture' data-toggle='tooltip' data-placement='bottom' title='' data-original-title='Dowload as a png'><i class='fa fa-lg fa-camera-retro'></i></button><a id='dowloadImage' href='#' style='display:none'>dowload</a>");
			$('#take_picture').on('click', function(){
				var dlbtn = document.getElementById("dowloadImage");
				var png64 = cy.png();
				dlbtn.href = png64;
				dlbtn.download = "YouTubeCrawlerTool-GraphExport-"+ dateFormat(new Date(),"dd/mm/yy h:MM TT") + ".png";
				dlbtn.click();
			});
            // Enable tooltips
            $('#cyOptions').tooltip({
                selector: "[data-toggle=tooltip]",
                container: "body"
            })
		    
	    };
	</script>
	
	<thymeleaf th:replace="sections/footer :: footer" />
</body>
</html>